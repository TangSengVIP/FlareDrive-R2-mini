name: Sync GitHub Release Assets to Cloudflare R2

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to sync (leave empty for latest)"
        required: false
        default: ""
  schedule:
    - cron: "0 3 * * *"

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      R2_ENDPOINT: https://${{ secrets.R2_ACCOUNT_ID }}.r2.cloudflarestorage.com
      R2_BUCKET: ${{ secrets.R2_BUCKET_NAME }}
      SOURCE_REPO: ${{ secrets.GH_SOURCE_REPO }}
      SOURCE_REPOS: ${{ secrets.GH_SOURCE_REPOS }}
    steps:
      - name: Checkout (for reference)
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          pipx install awscli

      - name: Configure AWS for R2
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
        run: |
          aws --version
          aws configure set aws_access_key_id "$AWS_ACCESS_KEY_ID"
          aws configure set aws_secret_access_key "$AWS_SECRET_ACCESS_KEY"
          aws configure set default.region "auto"

      - name: Resolve & download assets for single repo (fallback)
        env:
          GH_TOKEN: ${{ secrets.GH_SOURCE_TOKEN }}
        run: |
          # If multiple repos are provided, skip this step (handled in next step)
          if [ -n "$SOURCE_REPOS" ]; then
            echo "Multiple repos configured; skipping single-repo fallback"
            exit 0
          fi
          if [ -z "$SOURCE_REPO" ]; then
            echo "No SOURCE_REPO provided and no SOURCE_REPOS list; nothing to sync"
            exit 0
          fi
          TAG_INPUT='${{ github.event.inputs.tag }}'
          if [ -z "$TAG_INPUT" ]; then
            curl -s -H "Authorization: token $GH_TOKEN" \
              "https://api.github.com/repos/$SOURCE_REPO/releases/latest" > release.json
          else
            curl -s -H "Authorization: token $GH_TOKEN" \
              "https://api.github.com/repos/$SOURCE_REPO/releases/tags/$TAG_INPUT" > release.json
          fi
          mkdir -p downloads
          ASSET_COUNT=$(jq '.assets | length' release.json)
          echo "[$SOURCE_REPO] Found $ASSET_COUNT assets"
          for row in $(jq -r '.assets[] | @base64' release.json); do
            _jq() { echo ${row} | base64 -d | jq -r ${1}; }
            NAME=$(_jq '.name')
            URL=$(_jq '.browser_download_url')
            echo "Downloading $NAME"
            curl -L -H "Authorization: token $GH_TOKEN" -H "Accept: application/octet-stream" \
              "$URL" -o "downloads/$NAME"
          done
          aws s3 cp downloads/ s3://$R2_BUCKET/ --recursive --endpoint-url "$R2_ENDPOINT"
          aws s3 ls s3://$R2_BUCKET/ --endpoint-url "$R2_ENDPOINT" || true

      - name: Resolve & download assets for multiple repos
        if: env.SOURCE_REPOS != ''
        env:
          GH_TOKEN: ${{ secrets.GH_SOURCE_TOKEN }}
        run: |
          # Expected format in GH_SOURCE_REPOS: "owner1/repo1|prefix1;owner2/repo2|prefix2|v1.2.3"
          IFS=';' read -r -a ITEMS <<< "$SOURCE_REPOS"
          for ITEM in "${ITEMS[@]}"; do
            REPO=$(echo "$ITEM" | awk -F '|' '{print $1}')
            PREFIX=$(echo "$ITEM" | awk -F '|' '{print $2}')
            TAG_SPEC=$(echo "$ITEM" | awk -F '|' '{print $3}')
            TAG_INPUT='${{ github.event.inputs.tag }}'
            TAG=${TAG_SPEC:-$TAG_INPUT}
            echo "Processing repo=$REPO prefix=${PREFIX:-(root)} tag=${TAG:-latest}"
            if [ -z "$TAG" ]; then
              curl -s -H "Authorization: token $GH_TOKEN" \
                "https://api.github.com/repos/$REPO/releases/latest" > release.json
            else
              curl -s -H "Authorization: token $GH_TOKEN" \
                "https://api.github.com/repos/$REPO/releases/tags/$TAG" > release.json
            fi
            mkdir -p downloads
            ASSET_COUNT=$(jq '.assets | length' release.json)
            echo "[$REPO] Found $ASSET_COUNT assets"
            for row in $(jq -r '.assets[] | @base64' release.json); do
              _jq() { echo ${row} | base64 -d | jq -r ${1}; }
              NAME=$(_jq '.name')
              URL=$(_jq '.browser_download_url')
              echo "Downloading $NAME"
              curl -L -H "Authorization: token $GH_TOKEN" -H "Accept: application/octet-stream" \
                "$URL" -o "downloads/$NAME"
            done
            TARGET="s3://$R2_BUCKET/"
            if [ -n "$PREFIX" ]; then
              TARGET="s3://$R2_BUCKET/$PREFIX/"
            fi
            aws s3 cp downloads/ "$TARGET" --recursive --endpoint-url "$R2_ENDPOINT"
            rm -rf downloads
          done
          aws s3 ls s3://$R2_BUCKET/ --recursive --endpoint-url "$R2_ENDPOINT" || true
